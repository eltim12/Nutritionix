<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAojjGTWZG4GfhQQOJ1CW4U12SZnNVT_LA&callback=initMap"
        async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"
        integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>



    <title>Document</title>
</head>

<body>
    <div id='map' style="width: 500px; height: 400px;"></div>
    <button onclick="cariKopi()"></button>
    <br>
    <table>
        <thead>
            <tr>
                <td>no.</td>
                <td>tempat Ngopi</td>
                <td>distance</td>
                <td>time</td>
            </tr>
        </thead>
        <tbody id='listPlace'>
            <!-- <tr>
                <td>no.</td>
                <td>tempat Ngopi</td>
                <td>distance</td>
                <td>time</td>
            </tr> -->
        </tbody>
    </table>
</body>
<script>

    function cariKopi() {
        $.ajax({
                url: `http://localhost:3000/coffee/search?lat=${lat}&lon=${lng}&cuisines=1040&sortBy=rating&order=asc`,
                method: 'GET'
            })
            .done(data => {
                let restaurants = []
                data.map(el => {
                    let obj = {
                        lat: el.restaurant.location.latitude,
                        lng: el.restaurant.location.longitude,
                        name: el.restaurant.name,
                        address: el.restaurant.location.address,
                        rating: el.restaurant.user_rating.aggregate_rating,
                        cuisines: el.restaurant.cuisines
                    }
                    restaurants.push(obj)
                })

                for (let i = 0; i < restaurants.length; i++) {

                    let contentString = '<div id="content">' +
                        '<div id="siteNotice">' +
                        '</div>' +
                        `<h1 id="firstHeading" class="firstHeading">${restaurants[i].name}</h1>` +
                        '<div id="bodyContent">' +
                        `<p><b>${restaurants[i].address}</b></p>` +
                        `<p> cuisines : ${restaurants[i].cuisines}</p>` +
                        `<p> rating : ${restaurants[i].rating}</p>` +
                        '</div>' +
                        '</div>';

                    let infowindow = new google.maps.InfoWindow({
                        content: contentString
                    });

                    lat = +restaurants[i][0]
                    lng = +restaurants[i][1]

                    let myLatLng = {
                        lat: +restaurants[i].lat,
                        lng: +restaurants[i].lng,
                    };

                    let marker = new google.maps.Marker({
                        position: myLatLng,
                        map: map,
                        label: `${restaurants[i].name}`
                    });

                    marker.addListener('click', function () {
                        infowindow.open(map, marker);
                    });
                }

                let arrCoor = []
                restaurants.map(el => {
                    let tempCoor = `${el.lat},${el.lng}`
                    arrCoor.push(tempCoor)
                })

                arrCoor = arrCoor.join('|')

                console.log(arrCoor)

                $.ajax({
                        url: `http://localhost:3000/distance/?origin=${newLat},${newLng}&destinations=${arrCoor}`,
                        method: 'GET'
                    })
                    .done(map => {
                        console.log(map)
                    })
            })
            .fail(err => {
                console.log('hahahaha')
            })
    }


    $('document').ready(function () {

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            alert('Geolocation is not supported in your browser');
        }

        function showPosition(position) {
            lat = position.coords.latitude
            lng = position.coords.longitude
            initMap()
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {
                    lat: lat,
                    lng: lng
                },
                zoom: 15
            });

            var contentString = '<div id="content">' +
                '<div id="siteNotice">' +
                '</div>' +
                '<h1 id="firstHeading" class="firstHeading">Your Location</h1>' +
                '</div>';

            var infowindow = new google.maps.InfoWindow({
                content: contentString
            });

            var myLatLng = {
                lat,
                lng
            };
            var marker = new google.maps.Marker({
                position: myLatLng,
                map: map,
                label: 'Your Location'
            });

            marker.addListener('click', function () {
                infowindow.open(map, marker);
            });

        }

    })
</script>

</html>